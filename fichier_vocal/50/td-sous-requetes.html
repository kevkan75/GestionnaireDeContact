<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>td-sous-requetes</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}

kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb
}

* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
  body {
    padding: 2cm; 
  }
}
</style>


</head>

<body>

<h1 id="toc_0">TD - Les Sous-requêtes</h1>

<h2 id="toc_1">Introduction</h2>

<p>Vous allez travailler sur la base de données d&#39;une boutique en ligne de produits technologiques appelée TechnoShop. Cette session vous permettra d&#39;explorer différents types de sous-requêtes et de développer vos compétences en SQL.</p>

<h2 id="toc_2">Objectifs du TD</h2>

<ul>
<li>Comprendre et appliquer différents types de sous-requêtes</li>
<li>Résoudre des problèmes business réels avec SQL</li>
<li>Manipuler des données complexes avec des sous-requêtes</li>
<li>Développer des compétences analytiques SQL</li>
</ul>

<h2 id="toc_3">Quelques conseils</h2>

<ul>
<li>Les solutions sont fournies dans ce document. Prennez vore temps avant de les regarder.</li>
<li>Même si vous regardez les solutions, expérimentez avec elles, changez-les, testez des variants...</li>
</ul>

<h2 id="toc_4">Mise en place de l&#39;environnement (15 minutes)</h2>

<ol>
<li>Connectez-vous à MySQL Workbench</li>
<li>Exécutez le script <code>TechnoShopDB.sql</code> fourni pour créer et peupler la base de données</li>
<li>Vérifiez que toutes les tables ont été créées correctement avec leurs données:</li>
</ol>

<div><pre><code class="language-sql">USE techshop;
SHOW TABLES;</code></pre></div>

<h2 id="toc_5">Partie 1: Sous-requêtes Scalaires</h2>

<h3 id="toc_6">Introduction aux sous-requêtes scalaires</h3>

<p>Une sous-requête scalaire retourne une seule valeur et peut être utilisée partout où une expression de valeur unique est permise. Ces sous-requêtes sont fondamentales dans l&#39;analyse de données.</p>

<h3 id="toc_7">Exercice 1.1: Moyenne des produits</h3>

<p>Trouvez tous les produits dont le prix est supérieur à la moyenne des prix de tous les produits.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    product_id,
    name,
    price
FROM 
    products
WHERE 
    price &gt; (SELECT AVG(price) FROM products);</code></pre></div>

<p></details></p>

<h3 id="toc_8">Exercice 1.2: Top clients</h3>

<p>Identifiez les clients qui ont dépensé plus que la moyenne des dépenses par client. Affichez leur nom et le montant total de leurs achats.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    c.name,
    (SELECT SUM(oi.price_at_time * oi.quantity) 
     FROM orders o 
     JOIN order_items oi ON o.order_id = oi.order_id 
     WHERE o.customer_id = c.customer_id) AS total_spent
FROM 
    customers c
HAVING 
    total_spent &gt; (
        SELECT AVG(customer_total.total) 
        FROM (
            SELECT 
                o.customer_id,
                SUM(oi.price_at_time * oi.quantity) AS total
            FROM 
                orders o
            JOIN 
                order_items oi ON o.order_id = oi.order_id
            GROUP BY 
                o.customer_id
        ) AS customer_total
    );</code></pre></div>

<p></details></p>

<h3 id="toc_9">Exercice 1.3: Sous-requêtes dans CASE</h3>

<p>Catégorisez les produits en fonction de leur prix par rapport à la moyenne des prix de leur catégorie. Les catégories sont :</p>

<ul>
<li><code>Au-dessus de la moyenne</code></li>
<li><code>Prix moyen</code></li>
<li><code>En dessous de la moyenne</code></li>
</ul>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.name,
    p.price,
    p.category,
    CASE 
        WHEN p.price &gt; (SELECT AVG(price) FROM products WHERE category = p.category) 
        THEN &#39;Au-dessus de la moyenne&#39;
        WHEN p.price = (SELECT AVG(price) FROM products WHERE category = p.category) 
        THEN &#39;Prix moyen&#39;
        ELSE &#39;En dessous de la moyenne&#39;
    END AS price_category
FROM 
    products p
ORDER BY 
    p.category, p.price DESC;</code></pre></div>

<p></details></p>

<h3 id="toc_10">Exercice 1.4: Sous-requêtes multiples/imbriquées</h3>

<p>Trouvez le produit le plus cher qui a reçu au moins une évaluation 5 étoiles.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price
FROM 
    products p
WHERE 
    p.price = (
        SELECT MAX(price) 
        FROM products 
        WHERE product_id IN (
            SELECT product_id 
            FROM product_reviews 
            WHERE rating = 5
        )
    );</code></pre></div>

<p></details></p>

<h2 id="toc_11">Partie 2: Sous-requêtes avec IN, ANY et ALL</h2>

<h3 id="toc_12">Introduction aux sous-requêtes avec opérateurs</h3>

<p>Ces opérateurs permettent de comparer une valeur à un ensemble de valeurs retournées par une sous-requête.</p>

<h3 id="toc_13">Exercice 2.1: IN</h3>

<p>Trouvez tous les produits qui n&#39;ont jamais été commandés.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price,
    p.stock
FROM 
    products p
WHERE 
    p.product_id NOT IN (
        SELECT DISTINCT product_id 
        FROM order_items
    );</code></pre></div>

<p></details></p>

<h3 id="toc_14">Exercice 2.2: ANY</h3>

<p>Trouvez tous les produits dont le prix est supérieur à celui d&#39;au moins un produit de la catégorie &quot;Audio&quot;.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price,
    p.category
FROM 
    products p
WHERE 
    p.price &gt; ANY (
        SELECT price 
        FROM products 
        WHERE category = &#39;Audio&#39;
    );</code></pre></div>

<p></details></p>

<h3 id="toc_15">Exercice 2.3: ALL</h3>

<div><pre><code class="language-sql">-- D&#39;abord, créons une nouvelle commande pour John Doe (customer_id = 1)
INSERT INTO orders (customer_id, order_date, status, total_amount, delivery_address)
VALUES (1, NOW(), &#39;Delivered&#39;, 0, &#39;123 Elm Street, Cityville&#39;);

-- Récupérons l&#39;ID de cette commande
SET @new_order_id = LAST_INSERT_ID();

-- Maintenant, ajoutons tous les produits de catégorie &quot;Peripherals&quot; à cette commande
INSERT INTO order_items (order_id, product_id, quantity, price_at_time)
SELECT 
    @new_order_id, 
    p.product_id, 
    1, 
    p.price
FROM 
    products p
WHERE 
    p.category = &#39;Peripherals&#39;
    AND p.product_id NOT IN (
        -- Exclure les produits que John a déjà achetés
        SELECT oi.product_id
        FROM orders o
        JOIN order_items oi ON o.order_id = oi.order_id
        WHERE o.customer_id = 1
    );

-- Mettons à jour le montant total de la commande
UPDATE orders
SET total_amount = (
    SELECT SUM(quantity * price_at_time)
    FROM order_items
    WHERE order_id = @new_order_id
)
WHERE order_id = @new_order_id;</code></pre></div>

<p>Trouvez tous les clients qui ont acheté tous les produits de la catégorie &quot;Peripherals&quot;. Faites une version en combinant <code>ALL</code> et <code>EXISTS</code> une autre avec <code>COUNT</code>.</p>

<p><details>
<summary>Solution <code>ALL</code> et <code>EXISTS</code></summary></p>

<div><pre><code class="language-sql">SELECT 
    c.customer_id,
    c.name
FROM 
    customers c
WHERE 
    TRUE = ALL (
        SELECT 
            EXISTS (
                SELECT 1
                FROM orders o
                JOIN order_items oi ON o.order_id = oi.order_id
                WHERE o.customer_id = c.customer_id
                AND oi.product_id = p.product_id
            )
        FROM 
            products p
        WHERE 
            p.category = &#39;Peripherals&#39;
    );</code></pre></div>

<p></details></p>

<p><details>
<summary>Solution <code>COUNT</code></summary></p>

<div><pre><code class="language-sql">SELECT 
    c.customer_id,
    c.name
FROM 
    customers c
WHERE 
    (SELECT COUNT(DISTINCT p.product_id)
     FROM products p
     WHERE p.category = &#39;Peripherals&#39;) = 
    (SELECT COUNT(DISTINCT oi.product_id)
     FROM orders o
     JOIN order_items oi ON o.order_id = oi.order_id
     JOIN products p ON oi.product_id = p.product_id
     WHERE o.customer_id = c.customer_id
     AND p.category = &#39;Peripherals&#39;);</code></pre></div>

<p></details></p>

<h2 id="toc_16">Partie 3: Sous-requêtes dans la clause FROM</h2>

<h3 id="toc_17">Introduction aux sous-requêtes dans FROM</h3>

<p>Les sous-requêtes dans la clause FROM permettent de créer des &quot;tables dérivées&quot; utilisables dans la requête principale. C&#39;est très utile pour l&#39;agrégation et la préparation de données intermédiaires.</p>

<h3 id="toc_18">Exercice 3.1: Tables dérivées simples</h3>

<p>Créez un rapport des ventes par catégorie, montrant le nombre de produits vendus et le montant total des ventes.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.category,
    sales.total_quantity,
    ROUND(sales.total_amount, 2) AS total_amount
FROM 
    (
        SELECT 
            p.category,
            SUM(oi.quantity) AS total_quantity,
            SUM(oi.quantity * oi.price_at_time) AS total_amount
        FROM 
            order_items oi
        JOIN 
            products p ON oi.product_id = p.product_id
        GROUP BY 
            p.category
    ) AS sales
JOIN 
    products p ON p.category = sales.category
GROUP BY 
    p.category
ORDER BY 
    total_amount DESC;</code></pre></div>

<p></details></p>

<h3 id="toc_19">Exercice 3.2: Tables dérivées complexes</h3>

<p>Trouvez, pour chaque client, le produit le plus cher qu&#39;il a acheté, ainsi que sa catégorie.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    c.name AS customer_name,
    max_purchase.product_name,
    max_purchase.category,
    max_purchase.max_price
FROM 
    customers c
JOIN (
    SELECT 
        o.customer_id,
        p.name AS product_name,
        p.category,
        oi.price_at_time AS max_price
    FROM 
        orders o
    JOIN 
        order_items oi ON o.order_id = oi.order_id
    JOIN 
        products p ON oi.product_id = p.product_id
    WHERE 
        (o.customer_id, oi.price_at_time) IN (
            SELECT 
                o2.customer_id,
                MAX(oi2.price_at_time)
            FROM 
                orders o2
            JOIN 
                order_items oi2 ON o2.order_id = oi2.order_id
            GROUP BY 
                o2.customer_id
        )
) AS max_purchase ON c.customer_id = max_purchase.customer_id
ORDER BY 
    max_purchase.max_price DESC;</code></pre></div>

<p></details></p>

<h3 id="toc_20">Exercice 3.3: Fenêtrage avec tables dérivées</h3>

<p>Classez les produits par prix au sein de leur catégorie et affichez le rang, le nom du produit, le prix et la catégorie. Utilizé la fonction <a href="https://dev.mysql.com/doc/refman/8.4/en/window-function-descriptions.html#function_rank"><code>RANK</code></a></p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT
    ranked_products.product_name,
    ranked_products.price,
    ranked_products.category,
    ranked_products.price_rank
FROM (
    SELECT
        p.name AS product_name,
        p.price,
        p.category,
        RANK() OVER (PARTITION BY p.category ORDER BY p.price DESC) AS price_rank
    FROM
        products p
) AS ranked_products
ORDER BY
    ranked_products.category,
    ranked_products.price_rank;</code></pre></div>

<p></details></p>

<h2 id="toc_21">Partie 4: Sous-requêtes corrélées</h2>

<h3 id="toc_22">Introduction aux sous-requêtes corrélées</h3>

<p>Une sous-requête corrélée est une sous-requête qui dépend de la requête externe, créant ainsi une dépendance entre les deux requêtes. Ces requêtes sont puissantes mais peuvent être coûteuses en termes de performances.</p>

<h3 id="toc_23">Exercice 4.1: Comparaison avec moyenne</h3>

<p>Pour chaque produit, trouvez et affichez l&#39;écart entre son prix et le prix moyen des produits de la même catégorie.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">-- La condition WHERE category = p.category fait référence à p.category, 
-- qui est une colonne de la table dans la requête externe.
SELECT 
    p.name,
    p.price,
    p.category,
    p.price - (
        SELECT AVG(price)
        FROM products
        WHERE category = p.category
    ) AS price_difference,
    ROUND(
        (p.price / (
            SELECT AVG(price)
            FROM products
            WHERE category = p.category
        ) - 1) * 100, 
    2) AS percentage_difference
FROM 
    products p
ORDER BY 
    p.category,
    percentage_difference DESC;</code></pre></div>

<p></details></p>

<h3 id="toc_24">Exercice 4.2: Produits jamais achetés</h3>

<p>Utilisez NOT IN pour trouver tous les produits qui n&#39;ont jamais été achetés.</p>

<p><details>
<summary>Solution avec NOT IN</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price,
    p.stock
FROM 
    products p
WHERE 
    p.product_id NOT IN (
        SELECT product_id 
        FROM order_items
    );</code></pre></div>

<p></details></p>

<h3 id="toc_25">Exercice 4.3: Produits sans avis</h3>

<p>Trouvez tous les produits qui n&#39;ont pas encore reçu d&#39;avis client et qui sont en stock. Utilisez NOT IN.</p>

<p><details>
<summary>Solution avec NOT IN </summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price,
    p.stock,
    p.category
FROM 
    products p
WHERE 
    p.stock &gt; 0
    AND p.product_id NOT IN (
        SELECT product_id
        FROM product_reviews
    );</code></pre></div>

<p></details></p>

<h2 id="toc_26">Partie 5: Cas pratiques avancés</h2>

<h3 id="toc_27">Exercice 5.1: Analyse des commandes</h3>

<div><pre><code class="language-sql">-- D&#39;abbord...
-- Insérer un nouveau client
INSERT INTO customers (email, name, address, loyalty_level, last_visit, active)
VALUES (&#39;robert.johnson@example.com&#39;, &#39;Robert Johnson&#39;, &#39;123 New Street, Techville&#39;, &#39;New&#39;, NOW(), TRUE);

-- Récupérer l&#39;ID du client nouvellement créé
SET @new_customer_id = LAST_INSERT_ID();

-- Créer une commande pour ce client
INSERT INTO orders (customer_id, order_date, status, total_amount, delivery_address)
VALUES (@new_customer_id, NOW(), &#39;Pending&#39;, 159.99, &#39;123 New Street, Techville&#39;);

-- Récupérer l&#39;ID de la commande nouvellement créée
SET @new_order_id = LAST_INSERT_ID();

-- Ajouter un élément à cette commande
INSERT INTO order_items (order_id, product_id, quantity, price_at_time)
VALUES (@new_order_id, 5, 1, 159.99);

-- Supprimer tous les avis du client avec l&#39;ID 5 (ou un autre client de votre choix)
DELETE FROM product_reviews WHERE customer_id = 5;</code></pre></div>

<p>Identifiez les clients qui ont passé une commande mais n&#39;ont jamais laissé d&#39;avis sur les produits qu&#39;ils ont achetés. Utilisez NOT IN.</p>

<p><details>
<summary>Solution avec NOT IN </summary></p>

<div><pre><code class="language-sql">SELECT DISTINCT
    c.customer_id,
    c.name,
    c.email
FROM 
    customers c
JOIN 
    orders o ON c.customer_id = o.customer_id
WHERE 
    c.customer_id NOT IN (
        SELECT customer_id
        FROM product_reviews
    );</code></pre></div>

<p></details></p>

<h3 id="toc_28">Exercice 5.2: Analyse des prix</h3>

<p>Pour chaque produit, affichez le prix actuel et la date de la dernière modification de prix (depuis la table price_history).</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price AS current_price,
    (
        SELECT MAX(ph.change_date)
        FROM price_history ph
        WHERE ph.product_id = p.product_id
    ) AS last_price_change
FROM 
    products p;</code></pre></div>

<p></details></p>

<h3 id="toc_29">Exercice 5.3: Clients à potentiel</h3>

<p>Identifiez les clients qui ont des produits dans leur liste de souhaits mais n&#39;ont pas encore passé de commande pour ces produits. Utilisez NOT IN.</p>

<p><details>
<summary>Solution avec NOT IN </summary></p>

<div><pre><code class="language-sql">SELECT 
    c.customer_id,
    c.name,
    p.name AS wishlisted_product,
    p.price
FROM 
    customers c
JOIN 
    wishlist_items w ON c.customer_id = w.customer_id
JOIN 
    products p ON w.product_id = p.product_id
WHERE 
    (c.customer_id, w.product_id) NOT IN (
        SELECT o.customer_id, oi.product_id
        FROM orders o
        JOIN order_items oi ON o.order_id = oi.order_id
    );</code></pre></div>

<p></details></p>

<h3 id="toc_30">Utilisation de SOME avec comparaison</h3>

<h3 id="toc_31">Exercice 6.1: SOME avec comparaison</h3>

<p>Trouvez tous les produits dont le prix est inférieur à celui d&#39;au moins un produit de la catégorie &quot;Electronics&quot; mais supérieur à 100.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p.product_id,
    p.name,
    p.price,
    p.category
FROM 
    products p
WHERE 
    p.price &lt; SOME (
        SELECT price 
        FROM products 
        WHERE category = &#39;Electronics&#39;
    )
    AND p.price &gt; 100;</code></pre></div>

<p></details></p>

<h3 id="toc_32">Exercice supplémentaire 2: SOME avec jointure</h3>

<h3 id="toc_33">Exercice 6.2: SOME avec jointure</h3>

<p>Identifiez tous les clients qui ont passé une commande avec un montant total supérieur à celui d&#39;au moins une commande passée par un client &quot;Gold&quot;.</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT DISTINCT
    c.customer_id,
    c.name,
    c.loyalty_level,
    o.total_amount
FROM 
    customers c
JOIN 
    orders o ON c.customer_id = o.customer_id
WHERE 
    o.total_amount &gt; SOME (
        SELECT o2.total_amount
        FROM orders o2
        JOIN customers c2 ON o2.customer_id = c2.customer_id
        WHERE c2.loyalty_level = &#39;Gold&#39;
    )
    AND c.loyalty_level &lt;&gt; &#39;Gold&#39;
ORDER BY 
    o.total_amount DESC;</code></pre></div>

<p></details></p>

<h3 id="toc_34">Exercice supplémentaire 3: SOME avec sous-requête corrélée</h3>

<h3 id="toc_35">Exercice 6.3: SOME avec sous-requête corrélée</h3>

<p>Trouvez tous les produits dont le prix est supérieur à celui d&#39;au moins un produit fourni par le même fournisseur (supplier_id).</p>

<p><details>
<summary>Solution</summary></p>

<div><pre><code class="language-sql">SELECT 
    p1.product_id,
    p1.name,
    p1.price,
    p1.supplier_id,
    s.name AS supplier_name
FROM 
    products p1
JOIN 
    suppliers s ON p1.supplier_id = s.supplier_id
WHERE 
    p1.price &gt; SOME (
        SELECT p2.price
        FROM products p2
        WHERE p2.supplier_id = p1.supplier_id
        AND p2.product_id &lt;&gt; p1.product_id
    )
ORDER BY 
    p1.supplier_id, p1.price;</code></pre></div>

<p></details></p>

<h2 id="toc_36">Récapitulatif et conclusion</h2>

<p>Vous avez exploré plusieurs types de sous-requêtes:
1. <strong>Sous-requêtes scalaires</strong>: Retournent une seule valeur
2. <strong>Sous-requêtes avec IN, ANY, ALL et SOME</strong>: Comparent une valeur à un ensemble
3. <strong>Sous-requêtes dans FROM</strong>: Créent des tables dérivées
4. <strong>Sous-requêtes corrélées</strong>: Référencent la requête externe</p>

<p>Points clés à retenir:</p>

<ul>
<li>Les sous-requêtes permettent de décomposer des problèmes complexes</li>
<li>Différents types de sous-requêtes conviennent à différents problèmes</li>
<li>La performance peut varier selon l&#39;approche choisie</li>
<li>Les cas spéciaux (NULL, tables vides) nécessitent une attention particulière</li>
</ul>

<p>Pour approfondir:</p>

<ul>
<li>Explorez l&#39;utilisation des CTEs (Common Table Expressions) comme alternative aux sous-requêtes</li>
<li>Comparez les performances des différentes approches avec des jeux de données plus volumineux</li>
</ul>




</body>

</html>
